generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STANDARD
  READ_ONLY
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum OrderStatus {
  WIP
  FINISHED
  DELETED
}

enum ProductStatus {
  ACTIVE
  DISABLED
}

enum AttachmentType {
  GOOGLE_LINK
}

model User {
  displayName  String?
  id           String     @id @default(cuid())
  name         String
  username     String     @unique
  passwordHash String
  role         Role
  status       UserStatus @default(ACTIVE)
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())

  history       OrderHistory[]
  auditAsActor  AuditLog[]     @relation("AuditActor")
  auditAsTarget AuditLog[]     @relation("AuditTarget")
}

model Customer {
  id              String   @id @default(cuid())
  name            String
  phone           String?
  email           String?
  shippingAddress String
  dateAdded       DateTime @default(now())
  isArchived      Boolean  @default(false)

  orders Order[]
}

model Product {
  id        String        @id @default(cuid())
  name      String        @unique
  price     Decimal
  status    ProductStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model OrderSequence {
  id      Int @id @default(1)
  current Int
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  status      OrderStatus @default(WIP)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  finishedAt  DateTime?
  deletedAt   DateTime?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // customer snapshot (required)
  customerNameSnapshot            String
  customerPhoneSnapshot           String?
  customerEmailSnapshot           String?
  customerShippingAddressSnapshot String

  lineItems   OrderLineItem[]
  attachments Attachment[] // <-- keep THIS (Attachment system)
  history     OrderHistory[]
}

model OrderLineItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId           String
  productNameSnapshot String
  qty                 Int

  catalogUnitPriceSnapshot Decimal
  unitPriceFinal           Decimal
  isPriceOverridden        Boolean @default(false)
  overrideReason           String?

  lineTotal Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attachment {
  id                String         @id @default(cuid())
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  label             String
  attachmentType    AttachmentType @default(GOOGLE_LINK)
  createdAt         DateTime       @default(now())
  createdByInitials String?
  isArchived        Boolean        @default(false)

  versions AttachmentVersion[]

  @@unique([orderId, label])
}

model AttachmentVersion {
  id           String     @id @default(cuid())
  attachmentId String
  attachment   Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)

  versionNumber     Int
  googleUrl         String
  note              String?
  isCurrent         Boolean  @default(true)
  createdAt         DateTime @default(now())
  createdByInitials String

  @@unique([attachmentId, versionNumber])
  @@unique([attachmentId, googleUrl])
}

model OrderHistory {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  eventType   String
  timestamp   DateTime @default(now())
  initials    String?
  actorUserId String?
  actorUser   User?    @relation(fields: [actorUserId], references: [id])

  summary     String
  detailsJson Json
}

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action   String
  initials String?

  actorUserId String?
  actorUser   User?   @relation("AuditActor", fields: [actorUserId], references: [id])

  targetUserId String?
  targetUser   User?   @relation("AuditTarget", fields: [targetUserId], references: [id])

  details     String?
  detailsJson Json
}
